name: angle-natives

on:
  push:
    branches: [main]
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      ANGLE_COMMIT: ${{ steps.info.outputs.ANGLE_COMMIT }}
      VERSION: ${{ steps.info.outputs.VERSION }}
    steps:
      - name: Resolve ANGLE HEAD commit + version
        id: info
        shell: bash
        run: |
          set -euo pipefail
          SHA="$(git ls-remote https://chromium.googlesource.com/angle/angle HEAD | awk '{print $1}')"
          SHORT="${SHA:0:12}"

          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Make reruns publishable without 409 conflicts
            if [[ "${GITHUB_RUN_ATTEMPT:-1}" != "1" ]]; then
              VERSION="${VERSION}.r${GITHUB_RUN_ATTEMPT}"
            fi
          else
            VERSION="$(date -u +%Y%m%d).${SHORT}"
          fi

          echo "ANGLE_COMMIT=$SHA" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

  build:
    needs: resolve
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs_on: ubuntu-latest
            classifier: natives-linux
            os_dir: linux
            arch_dir: x86_64
            ext: so
            target_cpu: x64
            sysroot_arch: amd64

          # cross-build linux arm64 on x64 host
          - runs_on: ubuntu-latest
            classifier: natives-linux-arm64
            os_dir: linux
            arch_dir: arm64
            ext: so
            target_cpu: arm64
            sysroot_arch: arm64

          - runs_on: windows-latest
            classifier: natives-windows
            os_dir: windows
            arch_dir: x86_64
            ext: dll
            target_cpu: x64

          - runs_on: macos-15-intel
            classifier: natives-macos
            os_dir: osx
            arch_dir: x86_64
            ext: dylib
            target_cpu: x64

          - runs_on: macos-latest
            classifier: natives-macos-arm64
            os_dir: osx
            arch_dir: arm64
            ext: dylib
            target_cpu: arm64

    runs-on: ${{ matrix.runs_on }}
    env:
      ANGLE_COMMIT: ${{ needs.resolve.outputs.ANGLE_COMMIT }}
      CLASSIFIER: ${{ matrix.classifier }}
      TARGET_CPU: ${{ matrix.target_cpu }}
      DEPOT_TOOLS_WIN_TOOLCHAIN: "0"
      # Enable extra tracing/layers/symbols ONLY on non-release builds (Linux only in args.gn):
      ANGLE_DEBUG: ${{ github.event_name != 'release' }}

    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android || true
          sudo docker image prune -af || true
          df -h

      - name: Install depot_tools (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 https://chromium.googlesource.com/chromium/tools/depot_tools.git "$HOME/depot_tools"
          echo "$HOME/depot_tools" >> "$GITHUB_PATH"

      - name: Install depot_tools (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\Program Files\Git\cmd'
          $dt = Join-Path $env:USERPROFILE 'depot_tools'
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git $dt
          Add-Content -Path $env:GITHUB_PATH -Value $dt

      - name: Sync ANGLE + deps (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p work/angle
          cd work/angle

          cat > .gclient <<'EOF'
          solutions = [
            {
              "name": ".",
              "url": "https://chromium.googlesource.com/angle/angle.git",
              "deps_file": "DEPS",
              "managed": False,
              "custom_vars": {
                "checkout_angle_cl_deps": False,
                "checkout_angle_dawn_deps": False,
                "checkout_angle_internal": False,
                "checkout_angle_mesa": False,
                "checkout_angle_restricted_traces": False,
              },
            },
          ]
          EOF

          gclient sync --no-history -D --force --reset --revision .@"$ANGLE_COMMIT"

      - name: Sync ANGLE + deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path 'work\angle' | Out-Null
          Set-Location 'work\angle'

          @'
          solutions = [
            {
              "name": ".",
              "url": "https://chromium.googlesource.com/angle/angle.git",
              "deps_file": "DEPS",
              "managed": False,
              "custom_vars": {
                "checkout_angle_cl_deps": False,
                "checkout_angle_dawn_deps": False,
                "checkout_angle_internal": False,
                "checkout_angle_mesa": False,
                "checkout_angle_restricted_traces": False,
              },
            },
          ]
          '@ | Set-Content -Encoding ASCII .gclient

          gclient sync --no-history -D --force --reset --revision .@$env:ANGLE_COMMIT

      - name: Linux build deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          cd work/angle
          sudo ./build/install-build-deps.sh --no-prompt

      - name: Install Linux sysroot (amd64/arm64)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          cd work/angle
          python3 build/linux/sysroot_scripts/install-sysroot.py --arch=${{ matrix.sysroot_arch }}

      - name: Ensure in-tree clang toolchain is present (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          cd work/angle
          if [[ -f tools/clang/scripts/update.py ]]; then
            python3 tools/clang/scripts/update.py
          fi

      - name: Write args.gn + gn gen (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd work/angle
          mkdir -p out/Release

          DEBUG="${ANGLE_DEBUG}"

          {
            echo 'is_component_build = false'
            echo 'is_clang = true'
            echo 'use_lld = true'
            echo 'use_sysroot = true'
            echo "target_cpu = \"${TARGET_CPU}\""
            echo 'angle_enable_egl = true'
            echo 'angle_shared_libvulkan = false'

            if [[ "$DEBUG" == "true" ]]; then
              echo 'is_debug = true'
              echo 'symbol_level = 1'
              echo 'angle_assert_always_on = true'
              echo 'angle_enable_trace = true'
              echo 'angle_always_log_info = true'
            else
              echo 'is_debug = false'
              echo 'symbol_level = 0'
            fi

            case "${RUNNER_OS}" in
              macOS)
                echo 'angle_enable_metal = true'
                echo 'angle_enable_vulkan = true'
                echo 'angle_enable_gl = true'
                echo 'angle_enable_null = true'
                ;;
              Linux)
                # IMPORTANT for GLFW/X11/Wayland windowed EGL:
                echo 'angle_use_x11 = true'
                echo 'angle_use_wayland = true'
                echo 'ozone_platform_x11 = true'
                echo 'ozone_platform_wayland = true'
                echo 'angle_use_vulkan_display = true'

                echo 'angle_enable_vulkan = true'
                echo 'angle_enable_gl = true'
                echo 'angle_enable_null = true'

                # Debug-only (Linux): compile in Vulkan validation + API dump layer support
                if [[ "$DEBUG" == "true" ]]; then
                  echo 'angle_enable_vulkan_validation_layers = true'
                  echo 'angle_enable_vulkan_api_dump_layer = true'
                fi
                ;;
            esac
          } > out/Release/args.gn

          # Prefer ANGLE's in-tree clang if present (avoids host clang builtins issues)
          if [[ -x third_party/llvm-build/Release+Asserts/bin/clang ]]; then
            export PATH="$PWD/third_party/llvm-build/Release+Asserts/bin:$PATH"
          fi

          gn gen out/Release

      - name: Write args.gn + gn gen (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location 'work\angle'
          New-Item -ItemType Directory -Force -Path 'out\Release' | Out-Null

          @"
          is_debug = false
          is_component_build = false
          symbol_level = 0
          target_cpu = "$env:TARGET_CPU"
          angle_enable_d3d9 = false
          angle_enable_d3d11 = true
          angle_enable_vulkan = true
          angle_enable_gl = true
          angle_enable_null = true
          "@ | Set-Content -Encoding ASCII 'out\Release\args.gn'

          gn gen out/Release

      - name: Build libEGL + libGLESv2 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd work/angle

          if [[ -x third_party/llvm-build/Release+Asserts/bin/clang ]]; then
            export PATH="$PWD/third_party/llvm-build/Release+Asserts/bin:$PATH"
          fi

          autoninja -C out/Release libEGL libGLESv2

          # Debug tooling only for Linux + non-release builds.
          # Target names are not stable across ANGLE revisions; build best-effort and do not fail.
          if [[ "${ANGLE_DEBUG}" == "true" && "${RUNNER_OS}" == "Linux" ]]; then
            set +e
            autoninja -C out/Release \
              src/common/vulkan:vulkan_validation_layers \
              src/common/vulkan:lunarg_vulkantools
            set -e
          fi

      - name: Build libEGL + libGLESv2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location 'work\angle'
          autoninja -C out/Release libEGL libGLESv2

      - name: Stage runtime libs (Unix) into native/angle/...
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd work/angle

          OS_DIR="${{ matrix.os_dir }}"
          ARCH_DIR="${{ matrix.arch_dir }}"
          OUT="$GITHUB_WORKSPACE/dist/${CLASSIFIER}/native/angle/${OS_DIR}/${ARCH_DIR}"
          mkdir -p "$OUT"

          printf "ANGLE_COMMIT=%s\nRUNNER_OS=%s\nTARGET_CPU=%s\nANGLE_DEBUG=%s\n" \
            "$ANGLE_COMMIT" "$RUNNER_OS" "$TARGET_CPU" "$ANGLE_DEBUG" > "$OUT/ANGLE_BUILD_INFO.txt"
          cp -f LICENSE "$OUT/LICENSE.ANGLE" || true

          if [[ "${RUNNER_OS}" == "macOS" ]]; then
            cp -f out/Release/libEGL.dylib    "$OUT/libEGL.dylib"
            cp -f out/Release/libGLESv2.dylib "$OUT/libGLESv2.dylib"
          else
            cp -f out/Release/libEGL.so    "$OUT/libEGL.so"
            cp -f out/Release/libGLESv2.so "$OUT/libGLESv2.so"

            # SONAME-style aliases (some loaders expect these)
            cp -f "$OUT/libEGL.so"    "$OUT/libEGL.so.1"
            cp -f "$OUT/libGLESv2.so" "$OUT/libGLESv2.so.2"

            # Debug-only (Linux): ship any Vulkan layer JSONs + binaries if present
            if [[ "${ANGLE_DEBUG}" == "true" && "${RUNNER_OS}" == "Linux" ]]; then
              mkdir -p "$OUT/angledata"

              # Copy any generated layer JSONs and layer .so files (discovery-based; no "angledata" target needed)
              while IFS= read -r -d '' f; do
                cp -f "$f" "$OUT/angledata/"
              done < <(find out/Release -type f \( \
                    -name 'VkLayer_*.json' -o -name 'libVkLayer_*.so' \
                  \) -print0 2>/dev/null || true)

              # If ANGLE produced an angledata folder anyway, include it too
              if [[ -d out/Release/angledata ]]; then
                rsync -a out/Release/angledata/ "$OUT/angledata/" || true
              fi

            
            fi
          fi

      - name: Stage runtime libs (Windows) into native/angle/...
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location 'work\angle'

          $osDir   = "${{ matrix.os_dir }}"
          $archDir = "${{ matrix.arch_dir }}"
          $out = Join-Path $env:GITHUB_WORKSPACE ("dist\" + $env:CLASSIFIER + "\native\angle\" + $osDir + "\" + $archDir)
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          "ANGLE_COMMIT=$env:ANGLE_COMMIT`nRUNNER_OS=Windows`nTARGET_CPU=$env:TARGET_CPU`n" |
            Set-Content -Encoding ascii (Join-Path $out 'ANGLE_BUILD_INFO.txt')

          if (Test-Path 'LICENSE') { Copy-Item -Force 'LICENSE' (Join-Path $out 'LICENSE.ANGLE') }

          Copy-Item -Force 'out\Release\libEGL.dll'    (Join-Path $out 'libEGL.dll')
          Copy-Item -Force 'out\Release\libGLESv2.dll' (Join-Path $out 'libGLESv2.dll')

          foreach ($f in @('d3dcompiler_47.dll','dxcompiler.dll','dxil.dll')) {
            $p = Join-Path 'out\Release' $f
            if (Test-Path $p) { Copy-Item -Force $p $out }
          }

      - name: Upload staged files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.classifier }}
          path: dist/${{ matrix.classifier }}
          if-no-files-found: error

  package:
    needs: [resolve, build]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve.outputs.VERSION }}
    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Download staged artifacts
        uses: actions/download-artifact@v4
        with:
          path: angle-artifacts

      - name: Create jars (all-platform + per-classifier)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf maven-jars bundle
          mkdir -p maven-jars bundle

          # Merge all classifier artifacts into one folder (paths won't collide)
          for d in angle-artifacts/*; do
            rsync -a "$d/" bundle/
          done

          # All-platform jar (no classifier)
          jar cf "maven-jars/angle-natives-${VERSION}.jar" -C bundle .

          # Per-classifier jars
          ARTIFACT_ID="angle-natives"
          for d in angle-artifacts/*; do
            cls="$(basename "$d")"
            jar cf "maven-jars/${ARTIFACT_ID}-${VERSION}-${cls}.jar" -C "$d" .
          done

      - name: Upload Maven jars as artifact
        uses: actions/upload-artifact@v4
        with:
          name: angle-maven-jars
          path: maven-jars/*.jar
          if-no-files-found: error

  publish:
    needs: [resolve, package]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    env:
      VERSION: ${{ needs.resolve.outputs.VERSION }}
    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install Maven
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y maven

      - name: Download Maven jars
        uses: actions/download-artifact@v4
        with:
          name: angle-maven-jars
          path: maven-jars

      - name: Publish to GitHub Packages (Maven) - single deploy to avoid 409
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          GROUP_ID="io.github.${GITHUB_REPOSITORY_OWNER}"
          ARTIFACT_ID="angle-natives"
          REPO_URL="https://maven.pkg.github.com/${GITHUB_REPOSITORY}"

          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${GITHUB_ACTOR}</username>
                <password>${GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

          MAIN="maven-jars/${ARTIFACT_ID}-${VERSION}.jar"
          if [[ ! -f "$MAIN" ]]; then
            echo "Missing main jar: $MAIN" >&2
            exit 1
          fi

          # Build a single POM once
          POM="$(mktemp)"
          cat > "$POM" <<EOF
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>${GROUP_ID}</groupId>
            <artifactId>${ARTIFACT_ID}</artifactId>
            <version>${VERSION}</version>
            <packaging>jar</packaging>
          </project>
          EOF

          # Collect classifier jars
          mapfile -t EXTRAS < <(ls -1 "maven-jars/${ARTIFACT_ID}-${VERSION}-natives-"*.jar 2>/dev/null || true)

          if (( ${#EXTRAS[@]} == 0 )); then
            # Only main jar
            mvn -B deploy:deploy-file \
              -DrepositoryId=github \
              -Durl="$REPO_URL" \
              -DgroupId="$GROUP_ID" \
              -DartifactId="$ARTIFACT_ID" \
              -Dversion="$VERSION" \
              -Dpackaging=jar \
              -Dfile="$MAIN" \
              -DpomFile="$POM" \
              -DgeneratePom=false
            exit 0
          fi

          # Build comma-separated lists for the plugin
          FILES=""
          CLASSIFIERS=""
          TYPES=""

          for f in "${EXTRAS[@]}"; do
            base="$(basename "$f")"
            cls="${base#${ARTIFACT_ID}-${VERSION}-}"
            cls="${cls%.jar}"

            FILES+="${f},"
            CLASSIFIERS+="${cls},"
            TYPES+="jar,"
          done

          FILES="${FILES%,}"
          CLASSIFIERS="${CLASSIFIERS%,}"
          TYPES="${TYPES%,}"

          # Deploy everything in ONE request: main jar + attached classifier jars
          mvn -B deploy:deploy-file \
            -DrepositoryId=github \
            -Durl="$REPO_URL" \
            -DgroupId="$GROUP_ID" \
            -DartifactId="$ARTIFACT_ID" \
            -Dversion="$VERSION" \
            -Dpackaging=jar \
            -Dfile="$MAIN" \
            -DpomFile="$POM" \
            -DgeneratePom=false \
            -Dfiles="$FILES" \
            -Dclassifiers="$CLASSIFIERS" \
            -Dtypes="$TYPES"
