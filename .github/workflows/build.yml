name: angle-natives

on:
  push:
    branches: [main]
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      ANGLE_COMMIT: ${{ steps.info.outputs.ANGLE_COMMIT }}
      VERSION: ${{ steps.info.outputs.VERSION }}
    steps:
      - name: Resolve ANGLE HEAD commit + version
        id: info
        shell: bash
        run: |
          set -euo pipefail
          SHA="$(git ls-remote https://chromium.googlesource.com/angle/angle HEAD | awk '{print $1}')"
          SHORT="${SHA:0:12}"

          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Make reruns publishable without 409 conflicts
            if [[ "${GITHUB_RUN_ATTEMPT:-1}" != "1" ]]; then
              VERSION="${VERSION}.r${GITHUB_RUN_ATTEMPT}"
            fi
          else
            VERSION="$(date -u +%Y%m%d).${SHORT}"
          fi

          echo "ANGLE_COMMIT=$SHA" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

  build:
    needs: resolve
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs_on: ubuntu-latest
            classifier: natives-linux
            os_dir: linux
            arch_dir: x86_64
            target_cpu: x64

          - runs_on: ubuntu-latest
            classifier: natives-linux-arm64
            os_dir: linux
            arch_dir: arm64
            target_cpu: arm64

          - runs_on: windows-latest
            classifier: natives-windows
            os_dir: windows
            arch_dir: x86_64
            target_cpu: x64

          - runs_on: macos-15-intel
            classifier: natives-macos
            os_dir: osx
            arch_dir: x86_64
            target_cpu: x64

          - runs_on: macos-latest
            classifier: natives-macos-arm64
            os_dir: osx
            arch_dir: arm64
            target_cpu: arm64

    runs-on: ${{ matrix.runs_on }}
    env:
      ANGLE_COMMIT: ${{ needs.resolve.outputs.ANGLE_COMMIT }}
      CLASSIFIER: ${{ matrix.classifier }}
      TARGET_CPU: ${{ matrix.target_cpu }}
      DEPOT_TOOLS_WIN_TOOLCHAIN: "0"
      ANGLE_DEBUG: ${{ github.event_name != 'release' }}

    steps:

    
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare linux
        if: runner.os == 'Linux'
        shell: bash
        env: 
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android || true
          sudo apt update
          sudo apt install git curl build-essential python3 lsb-release file sudo -y
          df -h

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install depot_tools
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 https://chromium.googlesource.com/chromium/tools/depot_tools.git "$HOME/depot_tools"
          echo "$HOME/depot_tools" >> "$GITHUB_PATH"
          export PATH="$HOME/depot_tools:$PATH"

      - name: set depot_tools on windows path
        if: runner.os == 'Windows'
        shell: pwsh
        run: | 
          Add-Content -Path $env:GITHUB_PATH -Value "$env:USERPROFILE\depot_tools"

     

      - name: Prepare ANGLE 
        shell: bash
        if: runner.os == 'Linux' || runner.os == 'macOS'
        env:
          ARCH: ${{ matrix.target_cpu }}
          OS: ${{ matrix.os_dir }}
        run: |
          set -euo pipefail
          mkdir -p angle
          cd angle
          fetch angle
          if [ "$OS" == "linux" ]; then
            ./build/install-build-deps.sh --no-prompt
            if [ "$ARCH" == "arm64" ]; then
              python3 build/linux/sysroot_scripts/install-sysroot.py --arch=${{ matrix.target_cpu }}
            fi
          fi
          mkdir -p out/Release
          configFile="release-${{ matrix.os_dir }}-${{ matrix.target_cpu }}.gn"
          cp ../$configFile out/Release/args.gn
          gn gen out/Release

      - name: Prepare ANGLE 
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Set-PSDebug -Strict
          New-Item -ItemType Directory -Path angle
          Set-Location -Path angle
          fetch angle
          New-Item -ItemType Directory -Path out/Release
          $configFile="release-${{ matrix.os_dir }}-${{ matrix.target_cpu }}.gn"
          Copy-Item -Path "../$configFile" -Destination "out/Release/args.gn"
          gn gen out/Release
 

      - name: "Build"
        shell: bash
        run: |
          set -euo pipefail
          cd angle
          autoninja -C out/Release libEGL libGLESv2
 
      - name: Stage runtime libs into native/angle/...
        shell: bash
        run: |
          set -euo pipefail
          cd angle

          OS_DIR="${{ matrix.os_dir }}"
          ARCH_DIR="${{ matrix.arch_dir }}"
          OUT="$GITHUB_WORKSPACE/dist/${CLASSIFIER}/native/angle/${OS_DIR}/${ARCH_DIR}"
          mkdir -p "$OUT"

          printf "ANGLE_COMMIT=%s\nRUNNER_OS=%s\nTARGET_CPU=%s\nANGLE_DEBUG=%s\n" \
            "$ANGLE_COMMIT" "$RUNNER_OS" "$TARGET_CPU" "$ANGLE_DEBUG" > "$OUT/ANGLE_BUILD_INFO.txt"
            
          cp -f LICENSE "$OUT/LICENSE.ANGLE" || true

          cp -f out/Release/libEGL.*    "$OUT/"
          cp -f out/Release/libGLESv2.* "$OUT/"
          cp -f out/Release/d3dcompiler* "$OUT/" || true
          cp -f out/Release/dxcompiler*   "$OUT/" || true
          cp -f out/Release/dxil*         "$OUT/" || true
          rm -Rf "$OUT/"*.TOC || true

      - name: Upload staged files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.classifier }}
          path: dist/${{ matrix.classifier }}
          if-no-files-found: error

  package:
    needs: [resolve, build]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve.outputs.VERSION }}
    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Download staged artifacts
        uses: actions/download-artifact@v4
        with:
          path: angle-artifacts

      - name: Create jars (all-platform + per-classifier)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf maven-jars bundle
          mkdir -p maven-jars bundle

          # Merge all classifier artifacts into one folder (paths won't collide)
          for d in angle-artifacts/*; do
            rsync -a "$d/" bundle/
          done

          # All-platform jar (no classifier)
          jar cf "maven-jars/angle-natives-${VERSION}.jar" -C bundle .

          # Per-classifier jars
          ARTIFACT_ID="angle-natives"
          for d in angle-artifacts/*; do
            cls="$(basename "$d")"
            jar cf "maven-jars/${ARTIFACT_ID}-${VERSION}-${cls}.jar" -C "$d" .
          done

      - name: Upload Maven jars as artifact
        uses: actions/upload-artifact@v4
        with:
          name: angle-maven-jars
          path: maven-jars/*.jar
          if-no-files-found: error

  publish:
    needs: [resolve, package]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    env:
      VERSION: ${{ needs.resolve.outputs.VERSION }}
    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install Maven
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y maven

      - name: Download Maven jars
        uses: actions/download-artifact@v4
        with:
          name: angle-maven-jars
          path: maven-jars

      - name: Publish to GitHub Packages (Maven) - single deploy to avoid 409
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          GROUP_ID="io.github.${GITHUB_REPOSITORY_OWNER}"
          ARTIFACT_ID="angle-natives"
          REPO_URL="https://maven.pkg.github.com/${GITHUB_REPOSITORY}"

          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${GITHUB_ACTOR}</username>
                <password>${GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

          MAIN="maven-jars/${ARTIFACT_ID}-${VERSION}.jar"
          if [[ ! -f "$MAIN" ]]; then
            echo "Missing main jar: $MAIN" >&2
            exit 1
          fi

          # Build a single POM once
          POM="$(mktemp)"
          cat > "$POM" <<EOF
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>${GROUP_ID}</groupId>
            <artifactId>${ARTIFACT_ID}</artifactId>
            <version>${VERSION}</version>
            <packaging>jar</packaging>
          </project>
          EOF

          # Collect classifier jars
          mapfile -t EXTRAS < <(ls -1 "maven-jars/${ARTIFACT_ID}-${VERSION}-natives-"*.jar 2>/dev/null || true)

          if (( ${#EXTRAS[@]} == 0 )); then
            # Only main jar
            mvn -B deploy:deploy-file \
              -DrepositoryId=github \
              -Durl="$REPO_URL" \
              -DgroupId="$GROUP_ID" \
              -DartifactId="$ARTIFACT_ID" \
              -Dversion="$VERSION" \
              -Dpackaging=jar \
              -Dfile="$MAIN" \
              -DpomFile="$POM" \
              -DgeneratePom=false
            exit 0
          fi

          # Build comma-separated lists for the plugin
          FILES=""
          CLASSIFIERS=""
          TYPES=""

          for f in "${EXTRAS[@]}"; do
            base="$(basename "$f")"
            cls="${base#${ARTIFACT_ID}-${VERSION}-}"
            cls="${cls%.jar}"

            FILES+="${f},"
            CLASSIFIERS+="${cls},"
            TYPES+="jar,"
          done

          FILES="${FILES%,}"
          CLASSIFIERS="${CLASSIFIERS%,}"
          TYPES="${TYPES%,}"

          # Deploy everything in ONE request: main jar + attached classifier jars
          mvn -B deploy:deploy-file \
            -DrepositoryId=github \
            -Durl="$REPO_URL" \
            -DgroupId="$GROUP_ID" \
            -DartifactId="$ARTIFACT_ID" \
            -Dversion="$VERSION" \
            -Dpackaging=jar \
            -Dfile="$MAIN" \
            -DpomFile="$POM" \
            -DgeneratePom=false \
            -Dfiles="$FILES" \
            -Dclassifiers="$CLASSIFIERS" \
            -Dtypes="$TYPES"
